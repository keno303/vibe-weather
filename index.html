<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vibe Weather — Internet Mood Forecast</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --temp: 20;
  --accent: #FF3D00;
  --accent-dim: #FF3D0066;
  --surface: #111;
  --surface-2: #1a1a1a;
  --surface-3: #222;
  --text: #E8E6E3;
  --text-dim: #666;
  --text-muted: #444;
  --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
  --sans: 'Space Grotesk', -apple-system, sans-serif;
  --border: #2a2a2a;
}

html { background: #0a0a0a; }

body {
  font-family: var(--sans);
  min-height: 100vh;
  overflow-x: hidden;
  color: var(--text);
  background: #0a0a0a;
}

/* ===== GRAIN OVERLAY ===== */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;
  opacity: 0.035;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-repeat: repeat;
  background-size: 256px 256px;
}

/* ===== WEATHER ATMOSPHERE ===== */
#atmosphere {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  transition: opacity 2s ease;
}

/* Warm glow for sunny state */
.weather-sunny #atmosphere {
  background: radial-gradient(ellipse 80% 60% at 20% 30%, rgba(255,61,0,0.08) 0%, transparent 70%),
              radial-gradient(ellipse 60% 80% at 80% 70%, rgba(255,170,0,0.05) 0%, transparent 70%);
}

.weather-storm #atmosphere {
  background: radial-gradient(ellipse 100% 100% at 50% 50%, rgba(100,50,255,0.06) 0%, transparent 70%);
}

/* Rain canvas */
#rainCanvas {
  position: fixed;
  inset: 0;
  z-index: 1;
  pointer-events: none;
  opacity: 0;
  transition: opacity 1.5s ease;
}

.weather-rain #rainCanvas,
.weather-storm #rainCanvas { opacity: 1; }

/* Storm shake */
@keyframes stormShake {
  0%, 100% { transform: translate(0, 0); }
  10% { transform: translate(-2px, 1px); }
  30% { transform: translate(2px, -1px); }
  50% { transform: translate(-1px, 2px); }
  70% { transform: translate(1px, -2px); }
  90% { transform: translate(-2px, 0); }
}

.weather-storm .main-grid {
  animation: stormShake 0.5s ease-in-out infinite;
}

/* Lightning flash */
@keyframes lightning {
  0%, 95%, 100% { opacity: 0; }
  96%, 98% { opacity: 0.15; }
  97% { opacity: 0; }
}

.weather-storm::before {
  content: '';
  position: fixed;
  inset: 0;
  background: white;
  z-index: 2;
  pointer-events: none;
  animation: lightning 4s ease-in-out infinite;
}

/* ===== LOADING SCREEN ===== */
.loading {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  padding: 10vw;
  z-index: 100;
  background: #0a0a0a;
}

.loading h2 {
  font-family: var(--sans);
  font-size: clamp(2rem, 5vw, 4rem);
  font-weight: 700;
  letter-spacing: -0.04em;
  line-height: 1.1;
  color: var(--text);
  margin-bottom: 24px;
}

.loading-bar-track {
  width: min(400px, 60vw);
  height: 2px;
  background: var(--border);
  position: relative;
  overflow: hidden;
}

.loading-bar-fill {
  position: absolute;
  height: 100%;
  width: 40%;
  background: var(--accent);
  animation: loadSlide 1.2s ease-in-out infinite;
}

@keyframes loadSlide {
  0% { left: -40%; }
  100% { left: 100%; }
}

.loading-sub {
  font-family: var(--mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 20px;
  letter-spacing: 0.03em;
  text-transform: uppercase;
}

/* ===== MAIN GRID LAYOUT ===== */
.main-grid {
  display: none;
  position: relative;
  z-index: 5;
  min-height: 100vh;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto 1fr auto;
  grid-template-areas:
    "header  header"
    "temp    sidebar"
    "ticker  ticker";
  gap: 0;
}

.main-grid.visible {
  display: grid;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.main-grid.visible {
  animation: fadeIn 1s ease;
}

/* ===== HEADER BAR ===== */
.header-bar {
  grid-area: header;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 40px;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}

.header-bar .brand {
  color: var(--text);
  font-weight: 700;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-bar .brand::before {
  content: '';
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--accent);
  flex-shrink: 0;
}

.header-bar .live-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  background: #00ff88;
  border-radius: 50%;
  margin-right: 6px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ===== TEMPERATURE ZONE ===== */
.temp-zone {
  grid-area: temp;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 60px 40px;
  border-right: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}

.temp-zone .weather-icon-display {
  font-size: 48px;
  margin-bottom: 16px;
  line-height: 1;
}

.temp-zone .temp-value {
  font-family: var(--sans);
  font-size: clamp(160px, 20vw, 280px);
  font-weight: 700;
  letter-spacing: -0.06em;
  line-height: 0.85;
  color: var(--text);
  position: relative;
}

.temp-zone .temp-unit {
  font-family: var(--mono);
  font-size: clamp(24px, 3vw, 40px);
  font-weight: 300;
  color: var(--text-dim);
  vertical-align: super;
  letter-spacing: -0.02em;
}

.temp-zone .temp-label {
  font-family: var(--mono);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--accent);
  margin-top: 24px;
  font-weight: 500;
}

.temp-zone .temp-desc {
  font-family: var(--sans);
  font-size: 1rem;
  color: var(--text-dim);
  margin-top: 8px;
  font-weight: 300;
  max-width: 300px;
  line-height: 1.5;
}

/* ===== SIDEBAR (MOOD AXES) ===== */
.sidebar {
  grid-area: sidebar;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 60px 40px;
}

.sidebar-label {
  font-family: var(--mono);
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--text-dim);
  margin-bottom: 32px;
}

/* Editorial infographic axes */
.mood-axes {
  display: flex;
  flex-direction: column;
  gap: 40px;
}

.mood-axis {
  position: relative;
}

.mood-axis-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 12px;
}

.mood-axis-name {
  font-family: var(--mono);
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-dim);
}

.mood-axis-value {
  font-family: var(--sans);
  font-size: 2rem;
  font-weight: 700;
  letter-spacing: -0.03em;
  color: var(--text);
  line-height: 1;
}

.mood-axis-track {
  width: 100%;
  height: 2px;
  background: var(--border);
  position: relative;
}

.mood-axis-fill {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  transition: width 2s cubic-bezier(0.22, 1, 0.36, 1);
}

.mood-axis-fill.ax-happy { background: var(--accent); }
.mood-axis-fill.ax-peaceful { background: #00ff88; }
.mood-axis-fill.ax-optimistic { background: #4D9FFF; }

.mood-axis-marker {
  position: absolute;
  top: -5px;
  width: 12px;
  height: 12px;
  border: 2px solid;
  background: #0a0a0a;
  transform: translateX(-50%);
  transition: left 2s cubic-bezier(0.22, 1, 0.36, 1);
}

.mood-axis-marker.ax-happy { border-color: var(--accent); }
.mood-axis-marker.ax-peaceful { border-color: #00ff88; }
.mood-axis-marker.ax-optimistic { border-color: #4D9FFF; }

.mood-axis-range {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-family: var(--mono);
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
}

/* ===== TICKER / SOURCES ===== */
.ticker-zone {
  grid-area: ticker;
  border-top: 1px solid var(--border);
  overflow: hidden;
}

.ticker-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 40px;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--text-dim);
}

.ticker-header .ticker-tag {
  background: var(--accent);
  color: #000;
  padding: 2px 8px;
  font-weight: 700;
  font-size: 0.55rem;
  letter-spacing: 0.08em;
}

.ticker-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
}

.ticker-item {
  display: grid;
  grid-template-columns: 60px 1fr 80px;
  align-items: center;
  padding: 14px 40px;
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
  font-family: var(--mono);
  transition: background 0.2s ease;
  cursor: default;
}

.ticker-item:hover {
  background: var(--surface-2);
}

.ticker-item .t-score {
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.ticker-item .t-score.positive { color: #00ff88; }
.ticker-item .t-score.negative { color: var(--accent); }
.ticker-item .t-score.neutral { color: var(--text-dim); }

.ticker-item .t-title {
  font-family: var(--sans);
  font-size: 0.8rem;
  font-weight: 400;
  color: var(--text);
  line-height: 1.4;
  padding-right: 20px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.ticker-item .t-source {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-dim);
  text-align: right;
}

/* ===== FOOTER ===== */
.footer-bar {
  padding: 16px 40px;
  font-family: var(--mono);
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .main-grid {
    grid-template-columns: 1fr;
    grid-template-areas:
      "header"
      "temp"
      "sidebar"
      "ticker";
  }

  .temp-zone {
    border-right: none;
    border-bottom: 1px solid var(--border);
    padding: 40px 24px;
  }

  .sidebar {
    padding: 40px 24px;
    border-bottom: 1px solid var(--border);
  }

  .header-bar { padding: 16px 24px; }

  .ticker-list { grid-template-columns: 1fr; }

  .ticker-item { padding: 12px 24px; }

  .ticker-header { padding: 12px 24px; }

  .footer-bar { padding: 12px 24px; flex-direction: column; gap: 4px; }
}

@media (max-width: 480px) {
  .temp-zone .temp-value { font-size: 120px; }
  .ticker-item { grid-template-columns: 50px 1fr 60px; }
}
</style>
</head>
<body>

<div id="atmosphere"></div>
<canvas id="rainCanvas"></canvas>

<!-- Loading -->
<div class="loading" id="loading">
  <h2>Reading the<br>internet's mood</h2>
  <div class="loading-bar-track"><div class="loading-bar-fill"></div></div>
  <div class="loading-sub">Scanning Hacker News, Reddit, and more</div>
</div>

<!-- Main content -->
<div class="main-grid" id="main">
  <div class="header-bar">
    <div class="brand">VIBE WEATHER</div>
    <div><span class="live-dot"></span>LIVE SENTIMENT</div>
  </div>

  <div class="temp-zone">
    <div class="weather-icon-display" id="weatherIcon"></div>
    <div class="temp-value"><span id="tempValue">--</span><span class="temp-unit">&#176;V</span></div>
    <div class="temp-label" id="tempLabel">ANALYZING</div>
    <div class="temp-desc" id="tempDesc">Aggregating sentiment from live internet sources</div>
  </div>

  <div class="sidebar">
    <div class="sidebar-label">Mood Indices</div>
    <div class="mood-axes">
      <div class="mood-axis">
        <div class="mood-axis-header">
          <span class="mood-axis-name">Happiness</span>
          <span class="mood-axis-value" id="axisHappyVal">--</span>
        </div>
        <div class="mood-axis-track">
          <div class="mood-axis-fill ax-happy" id="axisHappy" style="width:0%"></div>
          <div class="mood-axis-marker ax-happy" id="axisHappyMarker" style="left:0%"></div>
        </div>
        <div class="mood-axis-range"><span>Despondent</span><span>Euphoric</span></div>
      </div>
      <div class="mood-axis">
        <div class="mood-axis-header">
          <span class="mood-axis-name">Peace Index</span>
          <span class="mood-axis-value" id="axisPeacefulVal">--</span>
        </div>
        <div class="mood-axis-track">
          <div class="mood-axis-fill ax-peaceful" id="axisPeaceful" style="width:0%"></div>
          <div class="mood-axis-marker ax-peaceful" id="axisPeacefulMarker" style="left:0%"></div>
        </div>
        <div class="mood-axis-range"><span>Hostile</span><span>Serene</span></div>
      </div>
      <div class="mood-axis">
        <div class="mood-axis-header">
          <span class="mood-axis-name">Outlook</span>
          <span class="mood-axis-value" id="axisOptimisticVal">--</span>
        </div>
        <div class="mood-axis-track">
          <div class="mood-axis-fill ax-optimistic" id="axisOptimistic" style="width:0%"></div>
          <div class="mood-axis-marker ax-optimistic" id="axisOptimisticMarker" style="left:0%"></div>
        </div>
        <div class="mood-axis-range"><span>Nihilistic</span><span>Visionary</span></div>
      </div>
    </div>
  </div>

  <div class="ticker-zone">
    <div class="ticker-header">
      <span class="ticker-tag">FEED</span>
      <span>Top sentiment signals</span>
    </div>
    <div class="ticker-list" id="sourcesList"></div>
    <div class="footer-bar">
      <span>Vibe Weather &mdash; Sentiment from live internet data</span>
      <span>Not actual weather</span>
    </div>
  </div>
</div>

<script>
// ============================================
// SENTIMENT LEXICON (AFINN-inspired + custom)
// ============================================
const POSITIVE = {
  'amazing':3,'awesome':3,'beautiful':3,'best':3,'brilliant':3,'celebrate':2,
  'cool':2,'excellent':3,'exciting':3,'fantastic':3,'free':1,'fun':2,'good':2,
  'great':3,'happy':3,'helpful':2,'hope':2,'impressive':2,'incredible':3,
  'innovation':2,'inspiring':3,'interesting':2,'joy':3,'launch':1,'love':3,
  'nice':2,'new':1,'open':1,'opportunity':2,'optimistic':3,'perfect':3,
  'positive':2,'powerful':2,'progress':2,'proud':2,'release':1,'remarkable':3,
  'revolutionary':3,'secure':2,'simple':1,'smart':2,'solve':2,'success':3,
  'super':2,'support':1,'sweet':2,'thank':2,'top':1,'upgrade':2,'useful':2,
  'win':2,'wonderful':3,'wow':3,'yes':1,'breakthrough':3,'fast':2,'better':2,
  'improve':2,'growing':2,'welcome':1,'peaceful':2,'calm':2,'kind':2,
  'generous':2,'delight':3,'thrive':2,'achieve':2,'empower':2,'reward':2,
  'grateful':3,'blessed':2,'excited':3
};

const NEGATIVE = {
  'abuse':3,'angry':3,'annoying':2,'attack':3,'awful':3,'bad':2,'ban':2,
  'bankrupt':3,'block':2,'boring':2,'broken':2,'bug':2,'burn':2,'cancel':2,
  'catastrophe':3,'chaos':3,'collapse':3,'complain':2,'concern':1,'conflict':2,
  'corrupt':3,'crash':3,'crisis':3,'critical':2,'cruel':3,'damage':3,'danger':3,
  'dead':3,'death':3,'debt':2,'decline':2,'defeat':2,'destroy':3,'die':3,
  'disaster':3,'discrimination':3,'doom':3,'dumb':2,'error':2,'evil':3,
  'exploit':3,'fail':3,'fear':3,'fight':2,'fire':2,'fraud':3,'frustrat':2,
  'fuck':3,'hate':3,'hell':2,'horrible':3,'hurt':3,'idiot':3,'illegal':3,
  'insane':2,'issue':1,'jail':2,'kill':3,'lack':1,'lag':2,'lame':2,'lawsuit':2,
  'lie':3,'lose':2,'loss':2,'lost':2,'mess':2,'miserable':3,'mistake':2,
  'murder':3,'nasty':3,'negative':2,'nightmare':3,'outage':2,'outrage':3,
  'pain':2,'panic':3,'pathetic':3,'penalty':2,'poison':3,'poor':2,'problem':2,
  'protest':2,'rage':3,'reject':2,'risk':1,'sad':2,'scam':3,'scare':2,
  'shame':3,'shit':3,'shock':2,'sick':2,'slow':1,'spam':2,'steal':3,'stop':1,
  'stress':2,'struggle':2,'stupid':3,'suck':3,'suffer':3,'terrible':3,
  'threat':3,'toxic':3,'tragic':3,'trouble':2,'ugly':2,'unfair':3,'upset':2,
  'victim':2,'violence':3,'virus':2,'vulnerable':2,'war':3,'warn':2,
  'waste':2,'weak':2,'weapon':3,'worry':2,'worst':3,'wrong':2,'wtf':3
};

// Axis-specific words
const ANGRY_WORDS = ['angry','rage','outrage','fury','furious','hate','attack','fight','war','protest','riot','violence','abuse','hostile','aggression','wtf','fuck'];
const PEACEFUL_WORDS = ['peace','peaceful','calm','gentle','harmony','kind','quiet','serene','mindful','meditate','relax','tranquil','zen','chill','ease'];
const OPTIMISTIC_WORDS = ['hope','future','progress','innovation','opportunity','growth','build','improve','better','dream','vision','advance','forward','promising','breakthrough'];
const PESSIMISTIC_WORDS = ['doom','collapse','decline','end','fear','hopeless','crisis','catastrophe','dystopia','bleak','grim','dark','fail','impossible','doomed'];

function scoreSentiment(text) {
  const words = text.toLowerCase().replace(/[^a-z\s]/g, ' ').split(/\s+/);
  let pos = 0, neg = 0, angry = 0, peaceful = 0, optimistic = 0, pessimistic = 0;

  for (const w of words) {
    if (POSITIVE[w]) pos += POSITIVE[w];
    if (NEGATIVE[w]) neg += NEGATIVE[w];
    if (ANGRY_WORDS.includes(w)) angry++;
    if (PEACEFUL_WORDS.includes(w)) peaceful++;
    if (OPTIMISTIC_WORDS.includes(w)) optimistic++;
    if (PESSIMISTIC_WORDS.includes(w)) pessimistic++;
  }

  return { pos, neg, angry, peaceful, optimistic, pessimistic, total: words.length };
}

function sentimentEmoji(score) {
  if (score > 2) return '\u2600\uFE0F';
  if (score > 0.5) return '\uD83C\uDF24\uFE0F';
  if (score > -0.5) return '\uD83C\uDF25\uFE0F';
  if (score > -2) return '\uD83C\uDF27\uFE0F';
  return '\u26C8\uFE0F';
}

// ============================================
// DATA FETCHING
// ============================================

async function fetchHN() {
  try {
    const res = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json');
    const ids = await res.json();
    const top30 = ids.slice(0, 30);
    const stories = await Promise.all(
      top30.map(id => fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(r => r.json()))
    );
    return stories.filter(s => s && s.title).map(s => ({
      title: s.title,
      text: s.title + (s.text ? ' ' + s.text : ''),
      url: s.url || `https://news.ycombinator.com/item?id=${s.id}`,
      source: 'Hacker News'
    }));
  } catch (e) {
    console.warn('HN fetch failed:', e);
    return [];
  }
}

async function fetchRedditViaJson() {
  try {
    // Reddit's .json endpoint sometimes works without CORS issues
    const res = await fetch('https://www.reddit.com/r/all/hot.json?limit=25', {
      headers: { 'Accept': 'application/json' }
    });
    if (!res.ok) throw new Error('Reddit blocked');
    const data = await res.json();
    return data.data.children.map(c => ({
      title: c.data.title,
      text: c.data.title + ' ' + (c.data.selftext || ''),
      url: `https://reddit.com${c.data.permalink}`,
      source: 'Reddit'
    }));
  } catch (e) {
    console.warn('Reddit fetch failed (CORS):', e);
    return [];
  }
}

// ============================================
// ANALYSIS & RENDERING
// ============================================

function analyze(items) {
  let totalPos = 0, totalNeg = 0;
  let totalAngry = 0, totalPeaceful = 0;
  let totalOptimistic = 0, totalPessimistic = 0;
  const scored = [];

  for (const item of items) {
    const s = scoreSentiment(item.text);
    const net = s.pos - s.neg;
    totalPos += s.pos;
    totalNeg += s.neg;
    totalAngry += s.angry;
    totalPeaceful += s.peaceful;
    totalOptimistic += s.optimistic;
    totalPessimistic += s.pessimistic;
    scored.push({ ...item, score: net, emoji: sentimentEmoji(net) });
  }

  const n = items.length || 1;
  const netSentiment = (totalPos - totalNeg) / n;

  // Normalize to 0-100 scale
  const happy = Math.min(100, Math.max(0, 50 + netSentiment * 8));
  const peaceful = Math.min(100, Math.max(0, 50 + (totalPeaceful - totalAngry) / n * 25));
  const optimistic = Math.min(100, Math.max(0, 50 + (totalOptimistic - totalPessimistic) / n * 25));

  // Temperature: map sentiment to 5-35\u00B0C range
  const temp = Math.round(5 + (happy / 100) * 30);

  // Sort by absolute score for "top vibes"
  scored.sort((a, b) => Math.abs(b.score) - Math.abs(a.score));

  return { temp, happy, peaceful, optimistic, topItems: scored.slice(0, 8) };
}

function getWeatherState(temp) {
  if (temp >= 28) return { icon: '\u2600\uFE0F', label: 'Radiant Vibes', desc: 'The internet is radiating warmth. Rare optimism detected across all channels.', weather: 'sunny' };
  if (temp >= 23) return { icon: '\uD83C\uDF24\uFE0F', label: 'Good Vibes', desc: 'Positive sentiment dominates. The digital commons are feeling generous today.', weather: 'clear' };
  if (temp >= 18) return { icon: '\u26C5', label: 'Mixed Signals', desc: 'Neither good nor bad. The internet is processing. Typical discourse patterns.', weather: 'mixed' };
  if (temp >= 13) return { icon: '\uD83C\uDF25\uFE0F', label: 'Cloudy Mood', desc: 'Skepticism and concern are gaining traction. Guard your attention.', weather: 'cloudy' };
  if (temp >= 8)  return { icon: '\uD83C\uDF27\uFE0F', label: 'Gloomy Internet', desc: 'Negativity saturates the feeds. Cynicism prevails. Touch grass.', weather: 'rain' };
  return { icon: '\u26C8\uFE0F', label: 'Internet Rage Storm', desc: 'Maximum hostility detected. All channels are on fire. Close your tabs.', weather: 'storm' };
}

function render(data) {
  const state = getWeatherState(data.temp);

  // Set weather class on body for atmospheric effects
  document.body.className = `weather-${state.weather}`;

  document.getElementById('weatherIcon').textContent = state.icon;
  document.getElementById('tempValue').textContent = data.temp;
  document.getElementById('tempLabel').textContent = state.label;
  document.getElementById('tempDesc').textContent = state.desc;

  // Update accent color based on temp
  if (data.temp >= 23) {
    document.documentElement.style.setProperty('--accent', '#FF6B00');
  } else if (data.temp < 13) {
    document.documentElement.style.setProperty('--accent', '#4D9FFF');
  }

  // Animate axes
  setTimeout(() => {
    document.getElementById('axisHappy').style.width = data.happy + '%';
    document.getElementById('axisHappyMarker').style.left = data.happy + '%';
    document.getElementById('axisHappyVal').textContent = Math.round(data.happy);

    document.getElementById('axisPeaceful').style.width = data.peaceful + '%';
    document.getElementById('axisPeacefulMarker').style.left = data.peaceful + '%';
    document.getElementById('axisPeacefulVal').textContent = Math.round(data.peaceful);

    document.getElementById('axisOptimistic').style.width = data.optimistic + '%';
    document.getElementById('axisOptimisticMarker').style.left = data.optimistic + '%';
    document.getElementById('axisOptimisticVal').textContent = Math.round(data.optimistic);
  }, 300);

  // Top items — Bloomberg terminal style
  const list = document.getElementById('sourcesList');
  list.innerHTML = data.topItems.map(item => {
    const scoreClass = item.score > 0 ? 'positive' : item.score < 0 ? 'negative' : 'neutral';
    const scoreStr = (item.score > 0 ? '+' : '') + item.score;
    return `
      <div class="ticker-item">
        <span class="t-score ${scoreClass}">${scoreStr}</span>
        <span class="t-title">${item.title}</span>
        <span class="t-source">${item.source}</span>
      </div>
    `;
  }).join('');

  // Show
  document.getElementById('loading').style.display = 'none';
  document.getElementById('main').classList.add('visible');

  // Weather effects
  initWeatherEffects(data.temp, state.weather);
}

// ============================================
// WEATHER EFFECTS SYSTEM
// ============================================

function initWeatherEffects(temp, weather) {
  const canvas = document.getElementById('rainCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });

  if (weather === 'rain' || weather === 'storm') {
    const drops = [];
    const count = weather === 'storm' ? 300 : 150;

    for (let i = 0; i < count; i++) {
      drops.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        len: Math.random() * 20 + 10,
        speed: Math.random() * 8 + 8,
        opacity: Math.random() * 0.3 + 0.1,
        wind: weather === 'storm' ? Math.random() * 4 + 2 : 1
      });
    }

    function animateRain() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const d of drops) {
        d.y += d.speed;
        d.x += d.wind;
        if (d.y > canvas.height) { d.y = -d.len; d.x = Math.random() * canvas.width; }
        if (d.x > canvas.width) d.x = 0;

        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x + d.wind * 0.5, d.y + d.len);
        ctx.strokeStyle = `rgba(180, 200, 230, ${d.opacity})`;
        ctx.lineWidth = 1;
        ctx.stroke();
      }
      requestAnimationFrame(animateRain);
    }
    animateRain();
  } else if (weather === 'sunny' || weather === 'clear') {
    // Floating warm particles
    const particles = [];
    const count = 30;
    for (let i = 0; i < count; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 2 + 0.5,
        speedY: -(Math.random() * 0.3 + 0.1),
        speedX: (Math.random() - 0.5) * 0.3,
        opacity: Math.random() * 0.15 + 0.05
      });
    }
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const p of particles) {
        p.y += p.speedY;
        p.x += p.speedX;
        if (p.y < -10) { p.y = canvas.height + 10; p.x = Math.random() * canvas.width; }
        if (p.x > canvas.width) p.x = 0;
        if (p.x < 0) p.x = canvas.width;

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 180, 100, ${p.opacity})`;
        ctx.fill();
      }
      requestAnimationFrame(animateParticles);
    }
    animateParticles();
  }
}

// ============================================
// MAIN
// ============================================

(async function main() {
  const [hn, reddit] = await Promise.all([fetchHN(), fetchRedditViaJson()]);
  const allItems = [...hn, ...reddit];

  if (allItems.length === 0) {
    document.querySelector('.loading h2').textContent = 'Could not reach any sources';
    document.querySelector('.loading-sub').textContent = 'CORS MIGHT BE BLOCKING REQUESTS. TRY HOSTING LOCALLY OR VIA A PROXY.';
    document.querySelector('.loading-bar-track').style.display = 'none';
    return;
  }

  const data = analyze(allItems);
  render(data);
})();
</script>
</body>
</html>
